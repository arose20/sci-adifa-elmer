
{% extends 'scatterplot.html' %}

{% block headcss %}
{{ super() }}
<style> circle { fill-opacity: 1 }</style>
{% endblock %}

{% block navbar %}
<nav class="navbar align-items-stretch navbar-light flex-md-nowrap p-0">
  <div class="w-100 d-none d-md-flex d-lg-flex">
    &nbsp
  </div>
  <ul class="navbar-nav border-left flex-row ">
    <li class="nav-item nav-logo border-right d-sm-block d-md-none">
      <a class="nav-link nav-link-logo text-nowrap p-3" href="{{ url_for('datasets.index') }}">
        <img class="align-middle m-auto img-fluid" src="/images/logo.svg" alt="Haniffa Lab">
      </a>
    </li>   
  </ul>
  <nav class="nav">
    <a href="#" class="nav-link nav-link-icon toggle-sidebar d-md-inline d-lg-none text-center border-left" data-toggle="collapse" data-target=".header-navbar" aria-expanded="false" aria-controls="header-navbar">
      <i class="fas fa-bars"></i>
    </a>
  </nav>
</nav>
{% endblock %} 

{% block sidebar %}
<!-- Main Sidebar -->
<div class="main-navbar">
  <nav class="navbar align-items-stretch navbar-light bg-white flex-md-nowrap p-0">
    <a class="navbar-brand" href="{{ url_for('datasets.index') }}">
      <img class="align-middle m-auto" src="/images/logo.svg" alt="Haniffa Lab">
    </a>
    <a class="navbar-text" href="{{ url_for('datasets.index') }}">
      <span class="align-middle m-auto">CellAtlas.io</span>
    </a> 
    <a class="toggle-sidebar d-sm-inline d-md-none d-lg-none">
      <i class="fas fa-arrow-left"></i>
    </a>     
  </nav>
</div>
<div class="nav-wrapper">
  <h6 class="main-sidebar__nav-title">Observations</h6>
  <ul class="nav flex-column">
    <div id="obs-accordion">
      <div class="list-group list-group-flush">                                                              
        {% for ob in obs %}
          <div class="list-group-item justify-content-between align-items-center" data-toggle="collapse" data-target="#collapse{{loop.index}}" aria-controls="collapse{{loop.index}}">
            <h4>
              <i class="fa fa-plus-square"></i>&nbsp;&nbsp;{{ dataset.data_obs[ob]['name'] }}
            </h4>
          </div>
          <div id="collapse{{loop.index}}" class="collapse m-4 obs-values" aria-labelledby="heading{{loop.index}}" data-parent="#obs-accordion" data-name="{{ dataset.data_obs[ob]['name'] }}" data-id="{{loop.index}}" data-type="{{ dataset.data_obs[ob]['type'] }}">

            {% if dataset.data_obs[ob]['type'] == "categorical" %}
            <div class="btn-group btn-group-toggle mb-4" role="group">
              <a class="btn btn-sm btn-white checkall" data-id="{{loop.index}}"><i class="far fa-2x fa-check-square"></i></a>
              <a class="btn btn-sm btn-white uncheckall" data-id="{{loop.index}}"><i class="far fa-2x fa-square"></i></a>
              <a class="btn btn-sm btn-white colourise" id="colourise{{loop.index}}" data-name="{{ dataset.data_obs[ob]['name'] }}" data-id="{{loop.index}}" data-type="{{ dataset.data_obs[ob]['type'] }}"><i class="fa fa-2x fa-tint"></i></a>
            </div>   
            <div class="list-group list-group-flush">
              {% for key, value in dataset.data_obs[ob]['values'].items()|sort(attribute=1) %}
              <div class="list-group-item p-1">
                <div id="obs-list-{{ob}}" class="row">
                  <div class="col-12">
                    <label class="label-checkbox">{{dataset.data_obs[ob]['values'][key]}}
                      <input class="obs_value_cb" id="obs-{{loop.index}}-value-{{key}}" type="checkbox" name="obs-{{value}}" value="{{value}}" checked="checked">
                      <span class="checkmark"></span>
                    </label>    
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
            {% elif dataset.data_obs[ob]['type'] == "continuous" %}
            <div class="btn-group btn-group-toggle mb-4" role="group">
              <a class="btn btn-sm btn-white colourise" id="colourise{{loop.index}}" data-name="{{ dataset.data_obs[ob]['name'] }}" data-id="{{loop.index}}" data-type="{{ dataset.data_obs[ob]['type'] }}"><i class="fa fa-2x fa-tint"></i></a>
            </div>   
            <div class="list-group list-group-flush">         
            <div class="list-group-item p-1">
              <div class="row">
                <div class="col-6">
                  Minimum
                </div>
                <div class="col-6 text-right">
                  {{ dataset.data_obs[ob]['min'] }}
                </div>
              </div>
            </div>
            <div class="list-group-item p-1">
              <div class="row">
                <div class="col-6">
                  Maximum
                </div>
                <div class="col-6 text-right">
                  {{ dataset.data_obs[ob]['max'] }}
                </div>
              </div>
            </div>
            <div class="list-group-item p-1">
              <div class="row">
                <div class="col-6">
                  Mean
                </div>
                <div class="col-6 text-right">
                  {{ dataset.data_obs[ob]['mean'] }}
                </div>
              </div>
            </div>
            <div class="list-group-item p-1">
              <div class="row">
                <div class="col-6">
                  Median
                </div>
                <div class="col-6 text-right">
                  {{ dataset.data_obs[ob]['median'] }}
                </div>
              </div>
            </div>
            </div>   
            {% else %}
            {% endif %}  
          </div>                          
        {% endfor %}
      </div>  
    </div>           
  </ul>
</div>
<!-- End Main Sidebar -->  
{% endblock %}

{% block content %}
<script src="https://unpkg.com/deck.gl@latest/dist.min.js"></script>
<script src="https://unpkg.com/@deck.gl/core@^8.0.0/debug.min.js"></script>
<div class="page-header row no-gutters pb-4">
  <div class="col-12 text-center text-sm-left mb-0">
    <div style="float:right">
      <div class="btn-group">
        <a class="btn btn-white" data-toggle="modal" data-target="#exampleModal">
          <i class="fa fa-download"></i>
        </a>   
        <a class="btn btn-white" data-toggle="modal" data-target="#exampleModal">
          Dataset
        </a> 
      </div>
      <div class="btn-group dropdown">
        <a class="btn btn-white">
          <i class="fas fa-project-diagram"></i>
        </a>        
        <button class="btn btn-white dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          Matrixplot
        </button>
        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuButton">
          <a class="dropdown-item" href="{{ url_for('datasets.scatterplot', id=did) }}">Scatterplot</a>
        </div>
      </div>      
    </div>
    <span class="text-uppercase page-subtitle"><a href="{{ url_for('datasets.index') }}">Datasets</a> &#187; {{dataset.title}}</span>
    <h3 class="page-title">Heatmap of the mean expression values</h3>
  </div>
</div>

<div class="row">
  <div class="col-lg-9 col-md-12">
    {% block visualisation %}
    <!-- Visualisation -->
    <div id="matrixplot-container" class="card card-small" data-datasetId="{{did}}"></div>
    <!-- End Visualisation -->
    {% endblock %}
  </div>
  <div class="col-lg-3 col-md-12">
    <div class='gene-sidebar'>
      {% block geneselector %}
      <!-- Gene selector -->
      <div class='card card-small'>
        <div class="card-header border-bottom">
          <h6 class="m-0">Gene Expression</h6>
        </div>        
        <div class="card-body p-0">
          <ul class="list-group list-group-flush">               
            <li class="list-group-item p-0">
              <h6 class="gene-sidebar-title">Search for genes</h6>        
            </li>          
            <li class="list-group-item">
              <select class="select2-gene-search"></select>
              <div id="search-genes-selected" class="mt-2"></div>
            </li>               
            <li class="list-group-item p-0">
              <h6 class="gene-sidebar-title">Genes implicated with diseases</h6>        
            </li>          
            <li class="list-group-item">
              <select class="select2-disease-search"></select>
              <div id="search-genes-disease-set" class="mt-2"></div>
            </li>
            {% if dataset.genes_deg %}
            <li class="list-group-item p-0">
              <h6 class="gene-sidebar-title">Differentially expressed genes</h6>        
            </li>                        
            <li class="list-group-item">
              {% for gene in dataset.genes_deg %}
              <button type="button" id="gene-deg-{{ gene }}" class="btn-gene-select btn btn-outline-info btn-sm">{{ gene }}</button>
              {% endfor %}
            </li>  
            {% endif %}
            {% if dataset.genes_curated %}   
            <li class="list-group-item p-0">
              <h6 class="gene-sidebar-title">Author curated genes</h6>              
            </li>        
            <div class="list-group-item">
              <button type="button" id="gene-deg-{{ gene }}" class="btn-gene-select btn btn-outline-info btn-sm">Select All</button>
              {% for gene in dataset.genes_curated %}
              <button type="button" id="gene-deg-{{ gene }}" class="btn-gene-select btn btn-outline-info btn-sm">{{ gene }}</button>
              {% endfor %}
            </div>   
            {% endif %}
          </ul>
        </div>      
      </div>
      {% endblock %}
    </div>
</div>
{% endblock %}

